# MESSENGER V2

## MESSENGER 

### 这是什么

Messenger V2协议或msgr2是Ceph在线协议的第二个主要修订版。它具有几个关键功能：

* 一种_安全_模式，对通过网络传递的所有数据进行加密
* 改进了身份验证有效负载的封装，可以将来集成新的身份验证模式（例如Kerberos）
* 改进了早期的功能公告和协商功能，支持将来的协议修订

Ceph守护程序现在可以绑定到多个端口，从而允许旧版Ceph客户端和支持v2的新客户端连接到同一集群。

默认情况下，监视器现在绑定到`3300` 新的v2协议的新IANA分配端口（ce4h或0xce4），同时还绑定到`6789`旧的v1协议的旧默认端口。

### 地址格式

在nautilus之前，所有网络地址的呈现方式都类似于 `1.2.3.4:567/89012`在IP地址，端口和随机数的位置，以唯一地标识网络上的客户端或守护程序。从nautilus开始，我们现在具有三种不同的地址类型：

* **v2**：`v2:1.2.3.4:578/89012`标识守护程序绑定到使用新v2协议的端口
* **v1**：`v1:1.2.3.4:578/89012`标识守护程序绑定到使用旧版v1协议的端口。以前显示的带有任何前缀的任何地址现在都显示为一个`v1:`地址。
* **TYPE\_ANY**地址标识可以说两种协议版本的客户端。在nautilus之前，客户端将显示为 `1.2.3.4:0/123456`，其中端口0表示它们是客户端，并且不接受传入连接。从Nautilus开始，这些客户端现在在内部由**TYPE\_ANY** 地址表示，并且仍显示为不带前缀，因为它们可能会使用v2或v1协议连接到守护程序，具体取决于守护程序使用的协议。

因为守护程序现在绑定到多个端口，所以现在用地址向量而不是单个地址来描述它们。例如，将监视器映射转储到Nautilus群集上现在包括以下行：

```text
epoch 1
fsid 50fcf227-be32-4bcb-8b41-34ca8370bd16
last_changed 2019-02-25 11:10:46.700821
created 2019-02-25 11:10:46.700821
min_mon_release 14 (nautilus)
0: [v2:10.0.0.10:3300/0,v1:10.0.0.10:6789/0] mon.foo
1: [v2:10.0.0.11:3300/0,v1:10.0.0.11:6789/0] mon.bar
2: [v2:10.0.0.12:3300/0,v1:10.0.0.12:6789/0] mon.baz
```

方括号或地址向量表示可以在多个端口（和协议）上访问同一守护程序。如果可能，任何连接到该守护程序的客户端或其他守护程序都将使用v2协议（首先列出）；否则，它将返回到旧版v1协议。旧版客户端将仅看到v1地址，并且将继续使用v1协议进行连接。

从Nautilus开始，`mon_host`配置选项和命令行选项支持相同的带括号的地址矢量语法。`-m <mon-host>`

#### 绑定的配置选项

两个新的配置选项控制是否使用v1和/或v2协议：

> * `ms_bind_msgr1` \[default：true\]控制守护程序是否绑定到使用v1协议的端口
> * `ms_bind_msgr2` \[default：true\]控制守护程序是否绑定到使用v2协议的端口

同样，两个选项控制是否使用IPv4和IPv6地址：

> * `ms_bind_ipv4` \[默认值：true\]控制守护程序是否绑定到IPv4地址
> * `ms_bind_ipv6` \[默认值：false\]控制守护程序是否绑定到IPv6地址

### 连接模式

v2协议支持两种连接模式：

* _crc_模式提供：

  * 建立连接时进行强力的初始身份验证（使用cephx，通过中间人或窃听者的保护对双方进行相互身份验证），以及
  * crc32c完整性检查，以防止由于片状硬件或宇宙射线引起的位翻转

  _CRC_模式并_不能_提供：

  * 保密（网络上的窃听者可以查看经过的所有身份验证后的流量）或
  * 保护免受中间人的恶意攻击（只要他们谨慎地调整crc32c值以使其匹配，谁就可以故意修改流量）

* _安全_模式提供：

  * 建立连接时进行强力的初始身份验证（使用cephx，通过中间人或窃听者的保护对双方进行相互身份验证），以及
  * 对所有认证后流量进行完全加密，包括加密完整性检查。

  在Nautilus中，安全模式使用[AES-GCM](https://en.wikipedia.org/wiki/Galois/Counter_Mode)流密码，该密码在现代处理器上通常非常快（例如，比SHA-256密码哈希更快）。

#### 连接模式的配置选项

对于大多数连接，有一些选项可以控制使用哪种模式：

* `ms_cluster_mode`是用于Ceph守护程序之间的集群内通信的连接模式（或允许的模式）。如果列出了多种模式，则首选首先列出的模式。
* `ms_service_mode` 是客户端连接到群集时允许使用的模式的列表。
* `ms_client_mode` 是连接模式的列表，按优先顺序排列，供客户端在与Ceph群集通话时使用（或允许）。

有一组并行的选项专门适用于监视器，允许管理员设置与监视器通信的不同（通常更安全）要求。

* `ms_mon_cluster_mode` 是显示器之间使用的连接模式（或允许的模式）。
* `ms_mon_service_mode` 是客户端或其他Ceph守护程序连接到监视器时允许使用的模式的列表。
* `ms_mon_client_mode` 是按优先顺序排列的连接模式列表，供客户端或非监视器守护程序在连接到监视器时使用。

### 从仅V1过渡到V2-PLUS- 

默认情况下，`ms_bind_msgr2`从Nautilus 14.2.z开始为true。但是，在监视器开始使用v2之前，只有有限的服务才能开始发布v2地址。

对于大多数用户，监视器绑定到`6789`v1协议的默认旧版端口。在这种情况下，启用v2非常简单：

```text
ceph mon enable-msgr2
```

如果监视器绑定到非标准端口，则需要为v2明确指定其他端口。例如，如果您的监视器`mon.a`绑定到`1.2.3.4:1111`，并且您想要在端口上添加v2 `1112`：

```text
ceph mon set-addrs a [v2:1.2.3.4:1112,v1:1.2.3.4:1111]
```

监视器绑定到v2后，每个守护程序将在下一次重新启动时开始发布v2地址。

### 更新CEPH.CONF和MON\_HOST 

在Nautilus之前，CLI用户或守护程序通常会通过中的`mon_host`选项来发现监视器`/etc/ceph/ceph.conf`。此选项的语法从Nautilus开始扩展，以允许支持新的方括号列表格式。例如，像这样的旧行：

```text
mon_host = 10.0.0.1:6789,10.0.0.2:6789,10.0.0.3:6789
```

可以更改为：

```text
mon_host = [v2:10.0.0.1:3300/0,v1:10.0.0.1:6789/0],[v2:10.0.0.2:3300/0,v1:10.0.0.2:6789/0],[v2:10.0.0.3:3300/0,v1:10.0.0.3:6789/0]
```

但是，当使用默认端口（`3300`和`6789`）时，可以将其省略：

```text
mon_host = 10.0.0.1,10.0.0.2,10.0.0.3
```

在监视器上启用v2后，`ceph.conf`可能需要更新以不指定任何端口（这通常是最简单的），或者显式指定v2和v1地址。但是请注意，Nautilus和更高版本仅能理解新的带括号语法，因此请不要在尚未升级其ceph软件包的主机上进行此更改。

在进行更新时`ceph.conf`，请注意新命令（该命令将生成一个准系统配置文件，其信​​息仅够到达监视器），并且 （将配置文件选项移至监视器的配置数据库中）可能会有所帮助。例如，：`ceph config generate-minimal-confceph config assimilate-conf`

```text
# ceph config assimilate-conf < /etc/ceph/ceph.conf
# ceph config generate-minimal-config > /etc/ceph/ceph.conf.new
# cat /etc/ceph/ceph.conf.new
# minimal ceph.conf for 0e5a806b-0ce5-4bc6-b949-aa6f68f5c2a3
[global]
        fsid = 0e5a806b-0ce5-4bc6-b949-aa6f68f5c2a3
        mon_host = [v2:10.0.0.1:3300/0,v1:10.0.0.1:6789/0]
# mv /etc/ceph/ceph.conf.new /etc/ceph/ceph.conf
```

### 协议

有关v2有线协议的详细说明，请参阅[msgr2协议](https://docs.ceph.com/docs/nautilus/dev/msgr2/#msgr2-protocol)。

